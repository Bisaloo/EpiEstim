---
title: "Dealing with missed generations of infections with EpiEstim"
author: "Andrea Brizzi"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Dealing with missed generations of infections with EpiEstim}
  %\VignetteEncoding{UTF-8}
---


```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(EpiEstim) 
library(ggplot2)
```


# Background

When a novel pathogen arises in a population, time may be needed before surveillance systems are set up and can identify infected individuals.
As such, the start of an epidemic may differ from the date of first reported case, and epidemiologists may need to take into account the impact of unobserved generations of infections on their analyses.

In the case of EpiEstim, the first estimates of the reproduction number (R~t~) are sensitive to the recent incidence history. 
Indeed, the denominator of the estimator depends on the term:
$$
\Lambda_t = \sum_{\tau < t} w_{t-\tau} I_\tau,
$$
where $(I_t)_{t}$ denotes incidence and $(w_j)_{j}$ the serial interval distribution. If the first cases are not observed, this sum will be truncated, hence the denominator will be underestimated and infectiousness overestimated. 

In Brizzi, O'Driscoll and Dorigatti (10.1093/cid/ciac138), we proposed a simple exponential growth model to impute missed generations of infections, leading to a reduction in bias in early R~t~ estimates.
This can now be implemented through `EpiEstim`'s `estimate_R` function, by setting the `backimputation_window` to an integer greater than 5, specifying the number of observations used to fit the exponential growth model.

In short, the method combines the strength of the exponential growth to estimate the basic reproduction number R~0 together with the capabilities of EpiEstim to detect changes in transmission dynamics.


# Why do we need backimputation?


## A simple toy scenario

To quickly introduce early overestimation issue, consider the case of constant incidence, for example $I_t = 10$. We would expect R~t~ to be constantly close to 1. However, estimates of R~t~ are decreasing, suggesting a reduction in pathogen infectiousness.

```{r early-bias, fig.width=7}
incid_constant <- rep(10, 50)
config <- make_config(list(mean_si = 7, std_si = 4))
estimate_R(incid=incid_constant, config=config, method='parametric_si') |> 
    plot("R")
```

The problem here is that EpiEstim implicitly assumes the 10 cases in day 2 to have been generated by cases in day 1! 
If this seems like an unlikely scenario, perform backimputation by setting `imputation_window` to an integer larger than 5:

```{r early-bias-fix, fig.width=7}
estimate_R(
    incid=incid_constant,
    backimputation_window=7,
    config=config,
    method='parametric_si') |> 
    plot("R")
```

In this case, the estimates are constant, as expected. 

## Real world scenario: UK COVID deaths

Let us now consider some real world data: UK COVID-19 deaths from 2020.
As reporting of deaths is more accurate and reliable than case reporting, it is unlikely that a large proportion of people died of COVID before the first reported death. 
However, we can use this dataset to show how left-censoring incidence may affects traditional EpiEstim estimates, and how the adjustment behaves more robustly.
We focus on the first 50 days of reports.

```{r covid-load, fig.width=7}
data(covid_deaths_2020_uk)
maxT <- 50

with(covid_deaths_2020_uk, {
    incid_covid <<- incidence$Incidence[1:maxT]
    config_covid <<- make_config(list(si_distr = si_distr))
})

no_truncation_no_imputation <- estimate_R(
                                          incid = incid_covid,
                                          method = "non_parametric_si",
                                          config= config_covid
)
plot(no_truncation_no_imputation, "R")


no_truncation_with_imputation <- estimate_R(
                                            backimputation_window = 8,
                                            incid = incid_covid,
                                            method = "non_parametric_si",
                                            config= config_covid
)

plot(no_truncation_with_imputation, "R")

time <- no_truncation_no_imputation$R[,c("t_start", "t_end")]
window_midpoint <- (time[,1] + time[,2])/2
original <- no_truncation_no_imputation$R[, "Mean(R)"]
adjusted <- no_truncation_with_imputation$R[, "Mean(R)"]

plot(
     x = window_midpoint, 
     y = round((adjusted-original)/original * 100, 2),
     main = "Percent reduction in mean R_t estimate due to imputation",
     xlab = "Midpoint of sliding window",
     ylab = "Percentage reduction"
)
```

In this case, the shape of the R~t~ estimates are similar for the two methods. 
Still, the imputation reduces the first R~t~ estimate from `r original[1]` to `r original[0]`.

Now let us assume the first two weeks of deaths were not observed. How would the two methods compare?

```{r, fig.width=7}

truncT <- 14

# fit EpiEstim
truncation_no_imputation <- estimate_R(
                                     incid = incid_covid[ -(1:truncT) ], 
                                     method = "non_parametric_si",
                                     config= config_covid
)

truncation_with_imputation <- estimate_R(
                                   backimputation_window = 10,
                                   incid = incid_covid[ -(1:truncT) ],
                                   method = "non_parametric_si",
                                   config= config_covid,
)

# add truncT to keep time consistent with previous estimates
truncation_with_imputation$R$t_end <- truncation_with_imputation$R$t_end + truncT 
truncation_with_imputation$R$t_start <- truncation_with_imputation$R$t_start + truncT 

truncation_no_imputation$R$t_end <- truncation_no_imputation$R$t_end + truncT 
truncation_no_imputation$R$t_start <- truncation_no_imputation$R$t_start + truncT 

# specify classes
truncation_with_imputation$R$imputation <- TRUE
truncation_with_imputation$R$truncation <- TRUE
truncation_no_imputation$R$imputation <- FALSE
truncation_no_imputation$R$truncation <- TRUE
no_truncation_with_imputation$R$imputation <- TRUE
no_truncation_with_imputation$R$truncation <- FALSE
no_truncation_no_imputation$R$imputation <- FALSE
no_truncation_no_imputation$R$truncation <- FALSE

plot.postmeans.side.by.side <- function(res1, res2, res3, res4)
{
    ggplot(data=res1$R, aes( 
                          x= (t_start + t_end)/2,
                          y=`Mean(R)`,
                          color=truncation,
                          linetype=imputation
                          ) ) + 
        geom_line() +
        geom_line(data=res2$R) +
        geom_line(data=res3$R) +
        geom_line(data=res4$R) +
        labs(x="Midpoint of sliding window", y="EpiEstim Posterior Mean") +
        theme_bw() +
        theme(legend.position = 'bottom')
}

plot.postmeans.side.by.side(
                            truncation_with_imputation,
                            truncation_no_imputation,
                            no_truncation_with_imputation,
                            no_truncation_no_imputation
)

```

As we can see, the imputation did not have too strong of an effect when death data were not truncated, as shown by the red lines. 
On the other hand, with truncated deaths data, the imputation procedure brought the R~t~ estimates closer to the ones obtained from the complete data.




## References

Andrea Brizzi, Megan O’Driscoll, Ilaria Dorigatti, Refining Reproduction Number Estimates to Account for Unobserved Generations of Infection in Emerging Epidemics, Clinical Infectious Diseases, Volume 75, Issue 1, 1 July 2022, Pages e114–e121, https://doi.org/10.1093/cid/ciac138
